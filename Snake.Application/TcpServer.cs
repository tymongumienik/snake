using System.ComponentModel;
using System.Net;
using System.Net.Sockets;
using System.Text;
using Snake.Application.Core;
using Snake.Application.Models;

namespace Snake.Application;

// inspired by https://medium.com/@jm.keuleyan/c-tcp-communications-building-a-client-server-chat-a2155d585191
// made async because learn.microsoft.com says so
public class TcpServer(GameManager manager)
{
    private readonly GameManager _manager = manager;

    private static class MagicBytes
    {
        public static byte[] SNAKE_ART = [0x1B, 0x5B, 0x33, 0x38, 0x3B, 0x35, 0x3B, 0x39, 0x33, 0x6D, 0x1B, 0x5B, 0x31, 0x6D, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x2F, 0x5E, 0x5C, 0x2F, 0x5E, 0x5C, 0x0D, 0x0A, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x5F, 0x7C, 0x5F, 0x5F, 0x7C, 0x20, 0x20, 0x4F, 0x7C, 0x0D, 0x0A, 0x5C, 0x2F, 0x20, 0x20, 0x20, 0x20, 0x20, 0x2F, 0x7E, 0x20, 0x20, 0x20, 0x20, 0x20, 0x5C, 0x5F, 0x2F, 0x20, 0x5C, 0x0D, 0x0A, 0x20, 0x5C, 0x5F, 0x5F, 0x5F, 0x5F, 0x7C, 0x5F, 0x5F, 0x5F, 0x5F, 0x5F, 0x5F, 0x5F, 0x5F, 0x5F, 0x5F, 0x2F, 0x20, 0x20, 0x5C, 0x0D, 0x0A, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x5C, 0x5F, 0x5F, 0x5F, 0x5F, 0x5F, 0x5F, 0x5F, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x5C, 0x0D, 0x0A, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x60, 0x5C, 0x20, 0x20, 0x20, 0x20, 0x20, 0x5C, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x5C, 0x0D, 0x0A, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x7C, 0x20, 0x20, 0x20, 0x20, 0x20, 0x7C, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x5C, 0x0D, 0x0A, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x2F, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x2F, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x5C, 0x0D, 0x0A, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x2F, 0x20, 0x20, 0x20, 0x20, 0x20, 0x2F, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x5C, 0x5C, 0x0D, 0x0A, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x2F, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x2F, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x5C, 0x20, 0x5C, 0x0D, 0x0A, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x2F, 0x20, 0x20, 0x20, 0x20, 0x20, 0x2F, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x5C, 0x20, 0x20, 0x5C, 0x0D, 0x0A, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x2F, 0x20, 0x20, 0x20, 0x20, 0x20, 0x2F, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x5F, 0x2D, 0x2D, 0x2D, 0x2D, 0x5F, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x5C, 0x20, 0x20, 0x20, 0x5C, 0x0D, 0x0A, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x2F, 0x20, 0x20, 0x20, 0x20, 0x20, 0x2F, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x5F, 0x2D, 0x7E, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x7E, 0x2D, 0x5F, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x7C, 0x20, 0x20, 0x20, 0x7C, 0x0D, 0x0A, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x28, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x28, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x5F, 0x2D, 0x7E, 0x20, 0x20, 0x20, 0x20, 0x5F, 0x2D, 0x2D, 0x5F, 0x20, 0x20, 0x20, 0x20, 0x7E, 0x2D, 0x5F, 0x20, 0x20, 0x20, 0x20, 0x20, 0x5F, 0x2F, 0x20, 0x20, 0x20, 0x7C, 0x0D, 0x0A, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x5C, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x7E, 0x2D, 0x5F, 0x5F, 0x5F, 0x5F, 0x2D, 0x7E, 0x20, 0x20, 0x20, 0x20, 0x5F, 0x2D, 0x7E, 0x20, 0x20, 0x20, 0x20, 0x7E, 0x2D, 0x5F, 0x20, 0x20, 0x20, 0x20, 0x7E, 0x2D, 0x5F, 0x2D, 0x7E, 0x20, 0x20, 0x20, 0x20, 0x2F, 0x0D, 0x0A, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x7E, 0x2D, 0x5F, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x5F, 0x2D, 0x7E, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x7E, 0x2D, 0x5F, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x5F, 0x2D, 0x7E, 0x0D, 0x0A, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x7E, 0x2D, 0x2D, 0x5F, 0x5F, 0x5F, 0x5F, 0x5F, 0x5F, 0x2D, 0x7E, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x7E, 0x2D, 0x5F, 0x5F, 0x5F, 0x2D, 0x7E, 0x0D, 0x0A, 0x1B, 0x5B, 0x30, 0x6D];
        public static byte[] CLEAR_SCREEN = [27, 91, 50, 74];
        public static byte[] RESET_CURSOR = [27, 91, 72];
        public static byte[] CLEAR_SCREEN_AND_RESET_CURSOR = [.. CLEAR_SCREEN, .. RESET_CURSOR];
    }

    private enum ConnectionStage
    {
        EnteringName,
        ConfiguringGridSize,
        Playing,
        GameEnded
    }

    public async Task StartAsync(int port)
    {
        var listener = new TcpListener(IPAddress.Any, port);
        listener.Start();

        Console.WriteLine($"Server started on port {port}!");

        while (true)
        {
            try
            {
                var client = await listener.AcceptTcpClientAsync();
                Console.WriteLine("Client connected!");

                _ = HandleClientAsync(client);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error accepting client: {ex}");
            }
        }
    }

    private async Task HandleClientAsync(TcpClient client)
    {
        using var stream = client.GetStream();
        var buffer = new byte[1024];
        var stage = ConnectionStage.EnteringName;

        async Task sendByteArray(byte[] bytes) => await stream.WriteAsync(bytes, 0, bytes.Length);
        async Task sendString(string s) => await sendByteArray(Encoding.UTF8.GetBytes(s));

        string username = string.Empty;
        uint gridSize = 8;

        async Task SendScreen()
        {
            await sendByteArray(MagicBytes.CLEAR_SCREEN_AND_RESET_CURSOR);
            switch (stage)
            {
                case ConnectionStage.EnteringName:
                    await sendByteArray(MagicBytes.SNAKE_ART);
                    await sendString($"\r\nPlease enter your name: {username}\r\nPress enter to confirm");
                    break;
                case ConnectionStage.ConfiguringGridSize:
                    await sendByteArray(MagicBytes.SNAKE_ART);
                    await sendString($"\r\nThe current grid size is {gridSize}\r\nUse W and S keys to adjust the size\r\nPress enter to start the game");
                    break;
            }
        }

        try
        {
            await SendScreen();

            while (true)
            {
                int bytesRead = await stream.ReadAsync(buffer, 0, buffer.Length);
                if (bytesRead == 0)
                {
                    Console.WriteLine("Client disconnected.");
                    break;
                }

                var slice = buffer[..bytesRead];

                switch (stage)
                {
                    case ConnectionStage.EnteringName:
                        // Backspace
                        if (slice.SequenceEqual("\x7F"u8))
                        {
                            username = string.IsNullOrEmpty(username) ? username : username[..^1];
                        }
                        // Enter
                        else if (slice.SequenceEqual("\r"u8))
                        {
                            if (GameConfig.IsValidUserName(username))
                            {
                                stage = ConnectionStage.ConfiguringGridSize;
                            }
                        }
                        // Letter
                        else if (Ascii.IsValid(slice))
                        {
                            string newUsername = username + Encoding.UTF8.GetString(slice);
                            if (GameConfig.IsValidUserName(newUsername))
                            {
                                username = newUsername;
                            }
                        }
                        break;
                    case ConnectionStage.ConfiguringGridSize:
                        // W
                        if (slice.SequenceEqual("W"u8) || slice.SequenceEqual("w"u8))
                        {
                            if (GameConfig.IsValidGridSize(gridSize + 1))
                            {
                                ++gridSize;
                            }
                        }
                        // S
                        else if (slice.SequenceEqual("S"u8) || slice.SequenceEqual("s"u8))
                        {
                            if (GameConfig.IsValidGridSize(gridSize - 1))
                            {
                                --gridSize;
                            }
                        }
                        // Enter
                        else if (slice.SequenceEqual("\r"u8))
                        {
                            stage = ConnectionStage.Playing;
                        }
                        break;
                    case ConnectionStage.Playing:
                        // TODO: impl
                        break;
                    case ConnectionStage.GameEnded:
                        // TODO: impl
                        break;
                }

                await SendScreen();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Client connection error: {ex.Message}");
        }
        finally
        {
            client.Close();
        }
    }
}
